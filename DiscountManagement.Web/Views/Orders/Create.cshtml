@model DiscountManagement.Application.DTOs.OrderDTO

<h2>Створити нове замовлення</h2>

<form method="post" action="@Url.Action("CreateOrder", "Orders")" class="order-form">
    <div>
        <label>Клієнт:</label>
        <select name="CustomerId" required>
            @foreach (var customer in ViewBag.Customers)
            {
                <option value="@customer.Id" data-discount="@customer.Discount">@customer.Name</option>
            }
        </select>
    </div>
    <div id="productsContainer"></div>
    <button type="button" id="addProductBtn">Додати продукт</button>
    <div>
        <label>Дата замовлення:</label>
        <input type="date" name="OrderDate" id="orderDate" required />
        <button type="button" id="setTodayBtn">Встановити сьогоднішню дату</button>
    </div>
    <div>
        <label>Загальна сума:</label>
        <input type="number" step="0.01" name="TotalAmount" required />
    </div>
    <!-- Приховані поля для зберігання ідентифікаторів продуктів та їх кількості -->
    <input type="hidden" id="hiddenProductIds" name="ProductIds" value="" />
    <input type="hidden" id="hiddenQuantities" name="Quantities" value="" />
    <div>
        <input type="submit" value="Створити" />
    </div>
</form>

<script>
    function calculateTotal() {
        var total = 0;
        var selects = document.querySelectorAll('select[name="ProductIds"]');
        var quantities = document.querySelectorAll('input[name="Quantities"]');
        
        for (var i = 0; i < selects.length; i++) {
            var price = parseFloat(selects[i].options[selects[i].selectedIndex].getAttribute('data-price'));
            var quantity = parseFloat(quantities[i].value);
            total += price * quantity;
        }

        const discount = '@ViewBag.CustomerDiscount' ? parseFloat('@ViewBag.CustomerDiscount') : 0;
        total = total * (1 - discount / 100);

        document.querySelector('input[name="TotalAmount"]').value = total.toFixed(2);
        document.getElementById('hiddenProductIds').value = Array.from(selects).map(s => s.value).join(',');
        document.getElementById('hiddenQuantities').value = Array.from(quantities).map(i => i.value).join(',');
    }

    document.getElementById('addProductBtn').addEventListener('click', function() {
        var productsContainer = document.getElementById('productsContainer');
        
        var select = document.createElement('select');
        select.name = "ProductIds";
        @foreach (var product in ViewBag.Products)
        {
            <text>
            var option = document.createElement('option');
            option.value = "@product.Id";
            option.setAttribute('data-price', "@product.Price");
            option.textContent = "@Html.Raw(product.Name) (@Html.Raw(product.Price.ToString()))";
            select.appendChild(option);
            </text>
        }
        
        var quantityInput = document.createElement('input');
        quantityInput.type = "number";
        quantityInput.name = "Quantities";
        quantityInput.min = "1";
        quantityInput.value = "1";
        
        productsContainer.appendChild(select);
        productsContainer.appendChild(quantityInput);

        calculateTotal();
    });
    
    document.getElementById('setTodayBtn').addEventListener('click', function() {
        var today = new Date().toISOString().split('T')[0];
        document.getElementById('orderDate').value = today;
    });
    
    document.querySelector('.order-form').addEventListener('change', function() {
        calculateTotal();
    });

    document.querySelectorAll('select[name="ProductIds"]').forEach(function(select) {
        select.addEventListener('change', calculateTotal);
    });
    document.querySelectorAll('input[name="Quantities"]').forEach(function(input) {
        input.addEventListener('input', calculateTotal);
    });
</script>
